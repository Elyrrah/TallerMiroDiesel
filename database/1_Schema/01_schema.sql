-- =============================================================================
-- 01 - SCHEMAS (Estructura)
-- Incluye: configuración, tablas, identity, defaults y constraints (FK)
-- =============================================================================

-- =============================================================================
-- CONFIGURACIÓN INICIAL
-- =============================================================================
SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET transaction_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

SET default_tablespace = '';
SET default_table_access_method = heap;

-- =============================================================================
-- TABLAS
-- =============================================================================

-- PAISES: lista de países
CREATE TABLE public.paises (
    id_pais bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre character varying(100) NOT NULL,
    iso2 char(2) UNIQUE,
    iso3 char(3) UNIQUE,
    activo boolean DEFAULT true NOT NULL
);

-- DEPARTAMENTOS: agrupación de ciudades por país
CREATE TABLE public.departamentos (
    id_departamento bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_pais bigint NOT NULL,
    nombre character varying(120) NOT NULL,
    activo boolean DEFAULT true NOT NULL,
    CONSTRAINT departamentos_id_pais_fkey
        FOREIGN KEY (id_pais) REFERENCES public.paises(id_pais)
);

-- CIUDADES: agrupación de distritos por departamento
CREATE TABLE public.ciudades (
    id_ciudad bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_departamento bigint NOT NULL,
    nombre character varying(120) NOT NULL,
    activo boolean DEFAULT true NOT NULL,
    CONSTRAINT ciudades_id_departamento_fkey
        FOREIGN KEY (id_departamento) REFERENCES public.departamentos(id_departamento),
    CONSTRAINT ciudades_unique_departamento_nombre
        UNIQUE (id_departamento, nombre)
);

-- DISTRITOS: barrios o zonas dentro de una ciudad
CREATE TABLE public.distritos (
    id_distrito bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_ciudad bigint NOT NULL,
    nombre character varying(120) NOT NULL,
    activo boolean DEFAULT true NOT NULL,
    CONSTRAINT distritos_id_ciudad_fkey
        FOREIGN KEY (id_ciudad) REFERENCES public.ciudades(id_ciudad),
    CONSTRAINT distritos_unique_ciudad_nombre
        UNIQUE (id_ciudad, nombre)
);

-- CLIENTES: tabla base de clientes
CREATE TABLE public.clientes (
    id_cliente bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    telefono character varying(30),
    email character varying(100),
    direccion character varying(255),
    id_ciudad bigint,
    id_distrito bigint,
    activo boolean DEFAULT true NOT NULL,
    fecha_creacion timestamp without time zone DEFAULT now() NOT NULL,
    CONSTRAINT clientes_id_ciudad_fkey
        FOREIGN KEY (id_ciudad) REFERENCES public.ciudades(id_ciudad),
    CONSTRAINT clientes_id_distrito_fkey
        FOREIGN KEY (id_distrito) REFERENCES public.distritos(id_distrito)
);

-- CLIENTES PERSONA: datos específicos de personas
CREATE TABLE public.clientes_persona (
    id_cliente bigint PRIMARY KEY,
    nombre character varying(120) NOT NULL,
    apellido character varying(120) NOT NULL,
    apodo character varying(30),
    activo boolean DEFAULT true NOT NULL,
    CONSTRAINT clientes_persona_id_cliente_fkey
        FOREIGN KEY (id_cliente) REFERENCES public.clientes(id_cliente)
);

-- CLIENTES EMPRESA: datos específicos de empresas
CREATE TABLE public.clientes_empresa (
    id_cliente bigint PRIMARY KEY,
    razon_social character varying(255) NOT NULL,
    nombre_fantasia character varying(50),
    activo boolean DEFAULT true NOT NULL,
    CONSTRAINT clientes_empresa_id_cliente_fkey
        FOREIGN KEY (id_cliente) REFERENCES public.clientes(id_cliente)
);

-- TIPOS DE DOCUMENTO: DNI, RUC, pasaporte, etc.
CREATE TABLE public.tipos_documento (
    id_tipo_documento bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre character varying(50) NOT NULL,
    codigo character varying(20) NOT NULL UNIQUE,
    aplica_a character varying(10) NOT NULL,
    activo boolean DEFAULT true NOT NULL
);

-- DOCUMENTOS DE CLIENTES: puede tener varios, con indicador de principal
CREATE TABLE public.cliente_documentos (
    id_cliente_documento bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_cliente bigint NOT NULL,
    id_tipo_documento bigint NOT NULL,
    numero character varying(40) NOT NULL,
    principal boolean DEFAULT false NOT NULL,
    activo boolean DEFAULT true NOT NULL,
    CONSTRAINT cliente_documentos_id_cliente_fkey
        FOREIGN KEY (id_cliente) REFERENCES public.clientes(id_cliente),
    CONSTRAINT cliente_documentos_id_tipo_documento_fkey
        FOREIGN KEY (id_tipo_documento) REFERENCES public.tipos_documento(id_tipo_documento)
);

-- MARCAS: marcas de vehículos o componentes
CREATE TABLE public.marcas (
    id_marca bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre character varying(50) NOT NULL UNIQUE,
    activo boolean DEFAULT true NOT NULL
);

-- MODELOS: modelos asociados a marcas
CREATE TABLE public.modelos (
    id_modelo bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_marca bigint NOT NULL,
    nombre character varying(50) NOT NULL,
    activo boolean DEFAULT true NOT NULL,
    CONSTRAINT modelos_id_marca_fkey
        FOREIGN KEY (id_marca) REFERENCES public.marcas(id_marca)
);

-- VEHÍCULOS: vehículos de clientes
CREATE TABLE public.vehiculos (
    id_vehiculo bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_cliente bigint NOT NULL,
    placa character varying(20) NOT NULL UNIQUE,
    id_marca bigint NOT NULL,
    id_modelo bigint,
    anio smallint,
    tipo_vehiculo character varying(20) NOT NULL,
    observaciones character varying(255),
    activo boolean DEFAULT true NOT NULL,
    CONSTRAINT vehiculos_id_cliente_fkey 
        FOREIGN KEY (id_cliente) REFERENCES public.clientes(id_cliente),
    CONSTRAINT vehiculos_id_marca_fkey 
        FOREIGN KEY (id_marca) REFERENCES public.marcas(id_marca),
    CONSTRAINT vehiculos_id_modelo_fkey 
        FOREIGN KEY (id_modelo) REFERENCES public.modelos(id_modelo)
);

-- COMPONENTES: piezas traídas sin vehículo
CREATE TABLE public.componentes (
    id_componente bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_cliente bigint NOT NULL,
    tipo_componente character varying(50) NOT NULL,
    id_marca bigint NOT NULL,
    id_modelo bigint NOT NULL,
    cantidad integer NOT NULL DEFAULT 1,
    observaciones character varying(255),
    activo boolean DEFAULT true NOT NULL,
    CONSTRAINT componentes_id_cliente_fkey
        FOREIGN KEY (id_cliente) REFERENCES public.clientes (id_cliente),
    CONSTRAINT componentes_id_marca_fkey
        FOREIGN KEY (id_marca) REFERENCES public.marcas (id_marca),
    CONSTRAINT componentes_id_modelo_fkey
        FOREIGN KEY (id_modelo) REFERENCES public.modelos (id_modelo)
);

-- SERVICIOS: trabajos ofrecidos en el taller
CREATE TABLE public.servicios (
    id_servicio bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    codigo character varying(20) NOT NULL UNIQUE,
    nombre character varying(120) NOT NULL, 
    descripcion character varying(255),
    precio_base numeric(14,0) DEFAULT 0 NOT NULL,
    activo boolean DEFAULT true NOT NULL,
    fecha_creacion timestamp without time zone DEFAULT now() NOT NULL
);

-- ROLES: catálogo de roles del sistema
CREATE TABLE IF NOT EXISTS public.roles (
    id_rol bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    codigo character varying(50) NOT NULL UNIQUE,
    nombre character varying(120) NOT NULL,
    descripcion character varying(255),
    activo boolean DEFAULT true NOT NULL,
    fecha_creacion timestamp without time zone DEFAULT now() NOT NULL
);

-- PERMISOS: catálogo de permisos/acciones del sistema
CREATE TABLE IF NOT EXISTS public.permisos (
    id_permiso bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    codigo character varying(80) NOT NULL UNIQUE,
    nombre character varying(120) NOT NULL,
    descripcion character varying(255),
    activo boolean DEFAULT true NOT NULL,
    fecha_creacion timestamp without time zone DEFAULT now() NOT NULL
);

-- ROLES_PERMISOS: permisos asociados a cada rol (N:M)
CREATE TABLE IF NOT EXISTS public.roles_permisos (
    id_rol bigint NOT NULL,
    id_permiso bigint NOT NULL,
    activo boolean DEFAULT true NOT NULL,
    fecha_creacion timestamp without time zone DEFAULT now() NOT NULL,
    CONSTRAINT roles_permisos_pkey PRIMARY KEY (id_rol, id_permiso),
    CONSTRAINT roles_permisos_id_rol_fkey
        FOREIGN KEY (id_rol) REFERENCES public.roles(id_rol),
    CONSTRAINT roles_permisos_id_permiso_fkey
        FOREIGN KEY (id_permiso) REFERENCES public.permisos(id_permiso)
);

-- USUARIOS: empleados o responsables de las OT
CREATE TABLE public.usuarios (
    id_usuario bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Is_rol bigint NOT NULL;
    nombre character varying(50) NOT NULL,
    apellido character varying(50) NOT NULL,
    nombre_usuario character varying(50) NOT NULL UNIQUE,
    email character varying(100) NOT NULL UNIQUE,
    password_hash character varying(255) NOT NULL,
    id_tipo_documento bigint NOT NULL,
    numero_documento character varying(40) NOT NULL,
    fecha_nacimiento date,
    activo boolean DEFAULT true NOT NULL,
    fecha_creacion timestamp without time zone DEFAULT now() NOT NULL,
    CONSTRAINT usuarios_id_tipo_documento_fkey
        FOREIGN KEY (id_tipo_documento) REFERENCES public.tipos_documento(id_tipo_documento)
    ADD CONSTRAINT usuarios_id_rol_fkey
        FOREIGN KEY (id_rol) REFERENCES public.roles(id_rol);
);

-- ORDENES_TRABAJO: tabla principal de operaciones
CREATE TABLE public.ordenes_trabajo (
    id_orden_trabajo bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    numero_orden character varying(30) NOT NULL UNIQUE, -- generado desde 03_Post
    id_usuario bigint NOT NULL,
    id_cliente bigint NOT NULL,
    tipo_ingreso public.tipo_ingreso_orden_enum NOT NULL,
    id_vehiculo bigint,
    id_componente bigint,
    fecha_ingreso timestamp without time zone DEFAULT now() NOT NULL,
    problema_reportado character varying(255),
    observaciones_ingreso character varying(255),
    estado public.estado_orden_trabajo_enum NOT NULL,
    fecha_entrega timestamp without time zone,
    total_estimado numeric(14,0) DEFAULT 0 NOT NULL,
    fecha_fin timestamp without time zone,
    activo boolean DEFAULT true NOT NULL,
    fecha_creacion timestamp without time zone DEFAULT now() NOT NULL,
    CONSTRAINT ordenes_trabajo_id_usuario_fkey
        FOREIGN KEY (id_usuario) REFERENCES public.usuarios(id_usuario),
    CONSTRAINT ordenes_trabajo_id_cliente_fkey
        FOREIGN KEY (id_cliente) REFERENCES public.clientes(id_cliente),
    CONSTRAINT ordenes_trabajo_id_vehiculo_fkey
        FOREIGN KEY (id_vehiculo) REFERENCES public.vehiculos(id_vehiculo),
    CONSTRAINT ordenes_trabajo_id_componente_fkey
        FOREIGN KEY (id_componente) REFERENCES public.componentes(id_componente)
);

-- DETALLES DE ORDEN: lista de servicios aplicados
CREATE TABLE public.orden_trabajo_detalles (
    id_detalle bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_orden_trabajo bigint NOT NULL,
    id_servicio bigint NOT NULL,
    descripcion character varying(255),
    cantidad integer NOT NULL DEFAULT 1,
    precio_unitario numeric(14,0),
    subtotal numeric(14,0) GENERATED ALWAYS AS (cantidad * precio_unitario) STORED,
    observaciones character varying(255),
    garantia_meses smallint,
    garantia_dias smallint,
    garantia_desde date,
    garantia_hasta date,
    activo boolean DEFAULT true NOT NULL,
    fecha_creacion timestamp without time zone DEFAULT now() NOT NULL,
    CONSTRAINT orden_trabajo_detalles_id_orden_trabajo_fkey
        FOREIGN KEY (id_orden_trabajo) REFERENCES public.ordenes_trabajo(id_orden_trabajo),
    CONSTRAINT orden_trabajo_detalles_id_servicio_fkey
        FOREIGN KEY (id_servicio) REFERENCES public.servicios(id_servicio)
);

-- PLANES DE PAGO: información sobre cuotas o crédito
CREATE TABLE public.planes_pago (
    id_plan_pago bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_orden_trabajo bigint NOT NULL,
    tipo_plan public.tipo_plan_pago_enum NOT NULL,
    estado public.estado_plan_pago_enum NOT NULL,
    fecha_inicio date DEFAULT CURRENT_DATE,
    fecha_vencimiento date,
    monto_cuota numeric(14,0) DEFAULT 0 NOT NULL,
    dia_pago smallint,
    cantidad_cuotas smallint DEFAULT 1 NOT NULL,
    observaciones character varying(255),
    activo boolean DEFAULT true NOT NULL,
    fecha_creacion timestamp without time zone DEFAULT now() NOT NULL,
    CONSTRAINT planes_pago_id_orden_trabajo_fkey
        FOREIGN KEY (id_orden_trabajo) REFERENCES public.ordenes_trabajo(id_orden_trabajo)
);

-- EVENTOS DE PLAN: registro de pagos, promesas o mora
CREATE TABLE public.planes_pago_eventos (
    id_evento bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_plan_pago bigint NOT NULL,
    fecha_evento timestamp without time zone DEFAULT now() NOT NULL,
    tipo_evento public.tipo_evento_plan_pago_enum NOT NULL,
    fecha_compromiso date,
    monto_compromiso numeric(14,0),
    detalle character varying(255),
    activo boolean DEFAULT true NOT NULL,
    CONSTRAINT planes_pago_eventos_id_plan_pago_fkey
        FOREIGN KEY (id_plan_pago) REFERENCES public.planes_pago(id_plan_pago)
);

-- PAGOS: registro de pagos realizados
CREATE TABLE public.pagos (
    id_pago bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_usuario bigint NOT NULL,
    id_orden_trabajo bigint NOT NULL,
    id_plan_pago bigint,
    fecha_pago timestamp without time zone DEFAULT now() NOT NULL,
    monto numeric(14,0) DEFAULT 0 NOT NULL,
    forma_pago public.forma_pago_enum NOT NULL,
    referencia character varying(80),
    observaciones character varying(255),
    activo boolean DEFAULT true NOT NULL,
    fecha_creacion timestamp without time zone DEFAULT now() NOT NULL,
    CONSTRAINT pagos_id_usuario_fkey
        FOREIGN KEY (id_usuario) REFERENCES public.usuarios(id_usuario),
    CONSTRAINT pagos_id_orden_trabajo_fkey
        FOREIGN KEY (id_orden_trabajo) REFERENCES public.ordenes_trabajo(id_orden_trabajo),
    CONSTRAINT pagos_id_plan_pago_fkey
        FOREIGN KEY (id_plan_pago) REFERENCES public.planes_pago(id_plan_pago)
);

-- =============================================================================
-- OWNER - PROPIETARIO DE OBJETOS
-- =============================================================================

-- Geografía
ALTER TABLE public.paises OWNER TO postgres;
ALTER TABLE public.departamentos OWNER TO postgres;
ALTER TABLE public.ciudades OWNER TO postgres;
ALTER TABLE public.distritos OWNER TO postgres;

-- Clientes y Documentos
ALTER TABLE public.clientes OWNER TO postgres;
ALTER TABLE public.clientes_persona OWNER TO postgres;
ALTER TABLE public.clientes_empresa OWNER TO postgres;
ALTER TABLE public.tipos_documento OWNER TO postgres;
ALTER TABLE public.cliente_documentos OWNER TO postgres;

-- Activos del Taller (Vehículos y Componentes)
ALTER TABLE public.marcas OWNER TO postgres;
ALTER TABLE public.modelos OWNER TO postgres;
ALTER TABLE public.vehiculos OWNER TO postgres;
ALTER TABLE public.componentes OWNER TO postgres;
ALTER TABLE public.servicios OWNER TO postgres;

-- Usuarios y Operaciones
ALTER TABLE public.usuarios OWNER TO postgres;
ALTER TABLE public.ordenes_trabajo OWNER TO postgres;
ALTER TABLE public.orden_trabajo_detalles OWNER TO postgres;

-- Finanzas (Planes y Pagos)
ALTER TABLE public.planes_pago OWNER TO postgres;
ALTER TABLE public.planes_pago_eventos OWNER TO postgres;
ALTER TABLE public.pagos OWNER TO postgres;

-- =============================================================================
-- FIN DEL SCRIPT 01_SCHEMA
-- =============================================================================